<script>
/* ======================
   CANVAS SETUP
   ====================== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let animationId;
let spawnTimer;

/* ======================
   GAME STATE
   ====================== */
let speed;
let gravity = 1;
let score1, score2;
let enemies = [];
let chakraOffset = 0;

/* ======================
   PLAYER FACTORY
   ====================== */
function makePlayer(yBase) {
  return {
    x: 60,
    y: yBase,
    baseY: yBase,
    w: 26,
    h: 36,
    vy: 0,
    duck: false,
    alive: true
  };
}

let p1, p2;

/* ======================
   PLAYER DRAW
   ====================== */
function drawRunner(p, color) {
  ctx.fillStyle = color;
  ctx.fillRect(p.x, p.y, p.w, p.h);
}

/* ======================
   NARUTO BACKGROUND
   ====================== */
function drawNarutoBackground() {
  // Sky gradient
  const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
  g.addColorStop(0, "#ffae42");
  g.addColorStop(1, "#ff6f00");
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Chakra streaks
  chakraOffset -= speed * 0.5;
  for (let i = 0; i < 10; i++) {
    ctx.fillStyle = "rgba(0,255,255,0.15)";
    ctx.fillRect((i * 200 + chakraOffset) % canvas.width, 0, 80, canvas.height);
  }

  // Hidden Leaf swirl symbols
  ctx.strokeStyle = "rgba(0,0,0,0.2)";
  for (let x = 100; x < canvas.width; x += 250) {
    for (let y = 60; y < canvas.height; y += 120) {
      ctx.beginPath();
      ctx.arc(x, y, 18, 0, Math.PI * 1.5);
      ctx.stroke();
    }
  }

  // Chakra divider
  ctx.strokeStyle = "#00ffff";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, 150);
  ctx.lineTo(canvas.width, 150);
  ctx.stroke();
  ctx.lineWidth = 1;
}

/* ======================
   ENEMIES (SHURIKEN)
   ====================== */
function spawnEnemy() {
  const lane = Math.random() < 0.5 ? 0 : 1;

  // Prevent impossible stacking
  if (enemies.some(e => e.lane === lane && e.x > canvas.width - 300)) return;

  const flying = Math.random() < 0.5;

  enemies.push({
    x: canvas.width,
    lane,
    flying,
    w: 24,
    h: flying ? 18 : 28
  });
}

/* ======================
   INPUT
   ====================== */
document.addEventListener("keydown", e => {
  if (e.key === "w") jump(p1);
  if (e.key === "s") duck(p1, true);
  if (e.key === "ArrowUp") jump(p2);
  if (e.key === "ArrowDown") duck(p2, true);
});

document.addEventListener("keyup", e => {
  if (e.key === "s") duck(p1, false);
  if (e.key === "ArrowDown") duck(p2, false);
});

function jump(p) {
  if (p.alive && p.y === p.baseY) p.vy = -15;
}

function duck(p, on) {
  p.duck = on;
  p.h = on ? 20 : 36;
  p.y = on ? p.baseY + 16 : p.baseY;
}

/* ======================
   GAME LOOP
   ====================== */
function update() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  drawNarutoBackground();

  [p1, p2].forEach(p => {
    if (!p.alive) return;
    p.vy += gravity;
    p.y += p.vy;
    if (p.y > p.baseY) {
      p.y = p.baseY;
      p.vy = 0;
    }
  });

  drawRunner(p1, "#0033ff");
  drawRunner(p2, "#00aa00");

  enemies.forEach((e, i) => {
    e.x -= speed;

    const laneY = e.lane === 0 ? 114 : 264;
    const y = e.flying ? laneY - 40 : laneY;

    // Shuriken look
    ctx.fillStyle = "#111";
    ctx.beginPath();
    ctx.arc(e.x, y + 10, 10, 0, Math.PI * 2);
    ctx.fill();

    [[p1,0],[p2,1]].forEach(([p,l]) => {
      if (!p.alive || e.lane !== l) return;
      if (
        p.x < e.x + e.w &&
        p.x + p.w > e.x &&
        p.y < y + e.h &&
        p.y + p.h > y
      ) p.alive = false;
    });

    if (e.x < -40) enemies.splice(i,1);
  });

  if (p1.alive) score1++;
  if (p2.alive) score2++;

  speed += 0.002;

  document.getElementById("ui").textContent =
    `P1: ${score1} ${p1.alive ? "" : "ðŸ’€"} | P2: ${score2} ${p2.alive ? "" : "ðŸ’€"}`;

  animationId = requestAnimationFrame(update);
}

/* ======================
   RESTART
   ====================== */
function restart() {
  cancelAnimationFrame(animationId);
  clearInterval(spawnTimer);

  speed = 5;
  score1 = score2 = 0;
  enemies = [];

  p1 = makePlayer(114);
  p2 = makePlayer(264);

  spawnTimer = setInterval(spawnEnemy, 1100);
  update();
}

restart();
</script>
